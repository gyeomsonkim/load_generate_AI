# Dashboard API Architecture

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Frontend (Next.js)                      â”‚
â”‚                     docs-site/dashboard                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTP Requests (X-API-Key Header)
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI Application                       â”‚
â”‚                   pathfinding-server                         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Middleware Layer                         â”‚  â”‚
â”‚  â”‚  - CORS Middleware                                    â”‚  â”‚
â”‚  â”‚  - ApiUsageTrackerMiddleware (ìë™ ì‚¬ìš©ëŸ‰ ì¶”ì )       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          API Routes Layer                             â”‚  â”‚
â”‚  â”‚                       â”‚                               â”‚  â”‚
â”‚  â”‚  /api/v1/auth        /api/v1/dashboard                â”‚  â”‚
â”‚  â”‚  - verify            - stats                          â”‚  â”‚
â”‚  â”‚                      - images                         â”‚  â”‚
â”‚  â”‚                      - usage                          â”‚  â”‚
â”‚  â”‚                      - api-keys (GET/POST/DELETE)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     Authentication & Authorization                    â”‚  â”‚
â”‚  â”‚  - verify_api_key() dependency                        â”‚  â”‚
â”‚  â”‚  - X-API-Key header validation                        â”‚  â”‚
â”‚  â”‚  - Auto last_used_at update                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          Business Logic Layer                         â”‚  â”‚
â”‚  â”‚  - Dashboard statistics calculation                   â”‚  â”‚
â”‚  â”‚  - Usage aggregation (hourly/daily)                   â”‚  â”‚
â”‚  â”‚  - API key generation & management                    â”‚  â”‚
â”‚  â”‚  - Image metadata retrieval                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            ORM Layer (SQLAlchemy Async)               â”‚  â”‚
â”‚  â”‚  - ApiKey model                                       â”‚  â”‚
â”‚  â”‚  - ApiUsage model                                     â”‚  â”‚
â”‚  â”‚  - UserImage model                                    â”‚  â”‚
â”‚  â”‚  - Map model (ê¸°ì¡´)                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ Async DB Queries
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PostgreSQL Database                          â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  api_keys    â”‚  â”‚  api_usage   â”‚  â”‚ user_images  â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ id           â”‚  â”‚ id           â”‚  â”‚ id           â”‚       â”‚
â”‚  â”‚ key (6ìë¦¬)  â”‚  â”‚ api_key_id   â”‚  â”‚ api_key_id   â”‚       â”‚
â”‚  â”‚ is_active    â”‚  â”‚ endpoint     â”‚  â”‚ map_id       â”‚       â”‚
â”‚  â”‚ usage_count  â”‚  â”‚ method       â”‚  â”‚ upload_time  â”‚       â”‚
â”‚  â”‚ created_at   â”‚  â”‚ status_code  â”‚  â”‚ is_deleted   â”‚       â”‚
â”‚  â”‚ last_used_at â”‚  â”‚ response_ms  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ timestamp    â”‚                         â”‚
â”‚                    â”‚ user_agent   â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                               â”‚
â”‚  Indexes:                                                     â”‚
â”‚  - api_keys.key (UNIQUE)                                     â”‚
â”‚  - api_usage.timestamp, endpoint, api_key_id                â”‚
â”‚  - user_images.api_key_id, map_id, is_deleted               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Request Flow

### 1. ì¸ì¦ ìš”ì²­ (POST /auth/verify)

```
Client
  â”‚
  â”‚ POST /api/v1/auth/verify
  â”‚ Body: {"api_key": "000000"}
  â”‚
  â–¼
ApiUsageTrackerMiddleware
  â”‚ â”œâ”€ ì‹œì‘ ì‹œê°„ ê¸°ë¡
  â”‚ â””â”€ API í‚¤ ì¶”ì¶œ
  â”‚
  â–¼
auth.verify_api_key()
  â”‚ â”œâ”€ DBì—ì„œ API í‚¤ ì¡°íšŒ
  â”‚ â”œâ”€ í™œì„±í™” ìƒíƒœ í™•ì¸
  â”‚ â”œâ”€ last_used_at ì—…ë°ì´íŠ¸
  â”‚ â””â”€ usage_count ì¦ê°€
  â”‚
  â–¼
Response
  â”‚ {"valid": true, "key_info": {...}}
  â”‚
  â–¼
ApiUsageTrackerMiddleware
  â”‚ â”œâ”€ ì‘ë‹µ ì‹œê°„ ê³„ì‚°
  â”‚ â”œâ”€ api_usage í…Œì´ë¸”ì— ê¸°ë¡
  â”‚ â””â”€ usage_count ì¦ê°€
  â”‚
  â–¼
Client
```

### 2. Dashboard í†µê³„ ì¡°íšŒ (GET /dashboard/stats)

```
Client
  â”‚
  â”‚ GET /api/v1/dashboard/stats
  â”‚ Header: X-API-Key: 000000
  â”‚
  â–¼
ApiUsageTrackerMiddleware
  â”‚ â””â”€ API í‚¤ ì¶”ì¶œ
  â”‚
  â–¼
verify_api_key() Dependency
  â”‚ â”œâ”€ X-API-Key í—¤ë” ê²€ì¦
  â”‚ â”œâ”€ DBì—ì„œ í™•ì¸
  â”‚ â””â”€ last_used_at ì—…ë°ì´íŠ¸
  â”‚
  â–¼
dashboard.get_dashboard_stats()
  â”‚
  â”œâ”€ ì „ì²´ ì‚¬ìš©ëŸ‰ ì§‘ê³„
  â”‚   SELECT COUNT(*) FROM api_usage WHERE api_key_id = ...
  â”‚
  â”œâ”€ ì‹œê°„ë³„ ì‚¬ìš©ëŸ‰ (24ì‹œê°„)
  â”‚   SELECT COUNT(*) ... GROUP BY hour
  â”‚
  â”œâ”€ ì¼ë³„ ì‚¬ìš©ëŸ‰ (7ì¼)
  â”‚   SELECT COUNT(*) ... GROUP BY date
  â”‚
  â”œâ”€ ì—”ë“œí¬ì¸íŠ¸ë³„ í†µê³„
  â”‚   SELECT endpoint, COUNT(*), AVG(response_time_ms)
  â”‚
  â””â”€ ìµœê·¼ ì—…ë¡œë“œ ì´ë¯¸ì§€ (6ê°œ)
      SELECT * FROM user_images JOIN maps
      WHERE api_key_id = ... LIMIT 6
  â”‚
  â–¼
Response
  â”‚ {
  â”‚   "usage": {...},
  â”‚   "hourly_usage": [...],
  â”‚   "daily_usage": [...],
  â”‚   "endpoint_usage": [...],
  â”‚   "recent_uploads": [...]
  â”‚ }
  â”‚
  â–¼
ApiUsageTrackerMiddleware
  â”‚ â””â”€ ì´ ìš”ì²­ë„ api_usageì— ê¸°ë¡ë¨
  â”‚
  â–¼
Client
```

---

## ğŸ—„ï¸ Database Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  api_keys   â”‚
â”‚  (ë¶€ëª¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1:N relationships
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                        â”‚                          â”‚
       â–¼                        â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  api_usage   â”‚       â”‚user_images  â”‚           â”‚  (ë‹¤ë¥¸ í…Œì´ë¸”) â”‚
â”‚              â”‚       â”‚             â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ api_key_id   â”‚       â”‚ api_key_id  â”‚
â”‚   (FK)       â”‚       â”‚   (FK)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚             â”‚
                       â”‚ map_id (FK) â”‚
                       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ N:1 relationship
                             â”‚
                             â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   maps   â”‚
                       â”‚  (ê¸°ì¡´)  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CASCADE DELETE:
- api_key ì‚­ì œ ì‹œ â†’ api_usage, user_images ìë™ ì‚­ì œ
- map ì‚­ì œ ì‹œ â†’ user_images ìë™ ì‚­ì œ
```

---

## ğŸ” Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API Request                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         Headerì— X-API-Key ìˆìŒ?
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚
       Yes               No
        â”‚                 â”‚
        â–¼                 â–¼
   verify_api_key()   401 Unauthorized
        â”‚
        â–¼
   DBì—ì„œ API í‚¤ ì¡°íšŒ
        â”‚
        â–¼
   í™œì„±í™” ìƒíƒœ í™•ì¸
        â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚         â”‚
Active    Inactive
   â”‚         â”‚
   â–¼         â–¼
last_used   401 Unauthorized
ì—…ë°ì´íŠ¸
   â”‚
   â–¼
ìš”ì²­ ì²˜ë¦¬
   â”‚
   â–¼
ì‘ë‹µ ë°˜í™˜
   â”‚
   â–¼
api_usage ê¸°ë¡
(ë¯¸ë“¤ì›¨ì–´)
```

---

## ğŸ“Š Data Flow - Usage Tracking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API ìš”ì²­ (ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ApiUsageTrackerMiddleware                         â”‚
â”‚                                                            â”‚
â”‚  start_time = time.time()                                 â”‚
â”‚  api_key = request.headers.get("X-API-Key")               â”‚
â”‚                                                            â”‚
â”‚  response = await call_next(request)                      â”‚
â”‚                                                            â”‚
â”‚  response_time = (time.time() - start_time) * 1000       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        API í‚¤ê°€ ìˆìŒ?
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚
       Yes               No
        â”‚                 â”‚
        â–¼                 â–¼
   ì‚¬ìš©ëŸ‰ ê¸°ë¡           skip
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  api_usage í…Œì´ë¸”ì— INSERT                                 â”‚
â”‚                                                            â”‚
â”‚  - api_key_id                                             â”‚
â”‚  - endpoint ("/api/v1/dashboard/stats")                   â”‚
â”‚  - method ("GET")                                         â”‚
â”‚  - status_code (200)                                      â”‚
â”‚  - response_time_ms (85.3)                                â”‚
â”‚  - timestamp (now)                                        â”‚
â”‚  - user_agent                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  api_keys.usage_count += 1                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
            ì‘ë‹µ ë°˜í™˜
```

---

## ğŸ¯ API Endpoints Hierarchy

```
/api/v1/
â”‚
â”œâ”€â”€ /auth
â”‚   â””â”€â”€ POST /verify                     # API í‚¤ ê²€ì¦
â”‚
â”œâ”€â”€ /dashboard
â”‚   â”œâ”€â”€ GET  /stats                      # ì¢…í•© í†µê³„
â”‚   â”œâ”€â”€ GET  /images                     # ì´ë¯¸ì§€ ëª©ë¡
â”‚   â”œâ”€â”€ GET  /usage?period=week          # ê¸°ê°„ë³„ ì‚¬ìš©ëŸ‰
â”‚   â”‚
â”‚   â””â”€â”€ /api-keys
â”‚       â”œâ”€â”€ GET    /                     # í‚¤ ëª©ë¡
â”‚       â”œâ”€â”€ POST   /                     # í‚¤ ìƒì„±
â”‚       â””â”€â”€ DELETE /{key_id}             # í‚¤ ì‚­ì œ
â”‚
â”œâ”€â”€ /pathfinding (ê¸°ì¡´)
â”‚   â”œâ”€â”€ POST /route
â”‚   â”œâ”€â”€ POST /validate-point
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ /maps (ê¸°ì¡´)
    â”œâ”€â”€ GET  /
    â”œâ”€â”€ POST /upload
    â””â”€â”€ ...
```

---

## ğŸ”„ State Management

### API Key States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Created    â”‚  is_active = True
â”‚              â”‚  usage_count = 0
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ ì‚¬ìš© ì‹œì‘
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Active    â”‚  is_active = True
â”‚              â”‚  usage_count > 0
â”‚              â”‚  last_used_at ì—…ë°ì´íŠ¸
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ ì‚­ì œ ìš”ì²­ (Soft Delete)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Inactive   â”‚  is_active = False
â”‚              â”‚  ê¸°ë¡ì€ ìœ ì§€ë¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### User Image States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Uploaded   â”‚  is_deleted = False
â”‚              â”‚  upload_timestamp ê¸°ë¡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ ì‚­ì œ ìš”ì²­
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Deleted    â”‚  is_deleted = True
â”‚              â”‚  ì‹¤ì œ ë°ì´í„°ëŠ” ìœ ì§€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Performance Optimizations

### 1. Database Indexes

```sql
-- api_keys í…Œì´ë¸”
CREATE INDEX idx_api_keys_key ON api_keys(key);
CREATE INDEX idx_api_keys_is_active ON api_keys(is_active);

-- api_usage í…Œì´ë¸” (ê°€ì¥ ë¹ˆë²ˆí•˜ê²Œ ì¿¼ë¦¬ë¨)
CREATE INDEX idx_api_usage_api_key_id ON api_usage(api_key_id);
CREATE INDEX idx_api_usage_timestamp ON api_usage(timestamp);
CREATE INDEX idx_api_usage_endpoint ON api_usage(endpoint);

-- user_images í…Œì´ë¸”
CREATE INDEX idx_user_images_api_key_id ON user_images(api_key_id);
CREATE INDEX idx_user_images_is_deleted ON user_images(is_deleted);
```

### 2. Async Processing

- ëª¨ë“  DB ì¿¼ë¦¬: SQLAlchemy async
- ë¯¸ë“¤ì›¨ì–´: ë¹„ë™ê¸° ì‚¬ìš©ëŸ‰ ê¸°ë¡
- Connection pool í™œìš©

### 3. Query Optimization

- JOIN ìµœì†Œí™”
- ì§‘ê³„ ì¿¼ë¦¬ ìµœì í™”
- LIMIT ì‚¬ìš© (recent_uploads: 6ê°œ)

---

## ğŸ”’ Security Layers

```
Layer 1: CORS Middleware
         â†“ í—ˆìš©ëœ originë§Œ ì ‘ê·¼

Layer 2: ApiUsageTrackerMiddleware
         â†“ ëª¨ë“  ìš”ì²­ ë¡œê¹…

Layer 3: verify_api_key() Dependency
         â†“ API í‚¤ ê²€ì¦ ë° í™œì„±í™” í™•ì¸

Layer 4: Business Logic
         â†“ API í‚¤ ì†Œìœ ê¶Œ í™•ì¸ (ë³¸ì¸ ë°ì´í„°ë§Œ)

Layer 5: Database
         â†“ Foreign key constraints
```

---

**Architecture Version:** 1.0.0
**Last Updated:** 2024-11-18
